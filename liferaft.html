<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Raft - Components Bay V3.3</title>
    <link rel="stylesheet" href="modern-style.css">
    <script type="module" src="supabase-config.js"></script>
    <style>
        .sub-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .sub-items-table th,
        .sub-items-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sub-items-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2d3748;
        }
        
        .sub-items-table tr:hover {
            background: #f7fafc;
        }
        
        .sub-items-table input[type="text"],
        .sub-items-table input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .expired-date {
            background: #fed7d7 !important;
            color: #c53030;
        }
        
        .expiring-soon {
            background: #fef5e7 !important;
            color: #dd6b20;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-left">
                <a href="http://10.10.0.21:8080/QATAR_V1_2/index.htm" target="_blank" class="nav-btn ietp-btn">üîó IETP</a>
                <a href="index.html" class="nav-btn">üè† Home</a>
            </div>
            <div class="nav-right">
                <button onclick="exportData()" class="nav-btn export-btn">üìä Export Excel</button>
                <span id="userInfo" class="nav-btn user-btn"></span>
                <button onclick="logout()" class="nav-btn logout-btn">üö™ Logout</button>
            </div>
        </div>

        <!-- Main Header -->
        <div class="main-header module-efs">
            <div class="header-content">
                <h1>üõü Life Raft</h1>
                <p>Life raft systems with 20 sub-components management</p>
            </div>
            <div class="header-actions">
                <button onclick="showAddLifeRaft()" class="btn btn-add">+ Add Life Raft</button>
                <button onclick="showAllLifeRafts()" class="btn">üìã View All Life Rafts</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card serviceable">
                <div class="summary-number" id="serviceableCount">0</div>
                <div class="summary-label">Serviceable</div>
            </div>
            <div class="summary-card unserviceable">
                <div class="summary-number" id="unserviceableCount">0</div>
                <div class="summary-label">Unserviceable</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalCount">0</div>
                <div class="summary-label">Total Life Rafts</div>
            </div>
        </div>

        <!-- Unserviceable Items Summary -->
        <div id="unserviceableSection" class="panel">
            <div class="panel-header" style="background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);">
                <span>‚ö†Ô∏è Unserviceable Life Rafts Summary</span>
                <span class="badge" id="unserviceableBadge">0</span>
            </div>
            <div class="panel-body">
                <div id="unserviceableTable"></div>
            </div>
        </div>

        <!-- Add Life Raft Form -->
        <div id="addLifeRaftForm" class="card hidden">
            <h2 style="margin-bottom: 25px;">Add Life Raft System</h2>
            <div id="liferaftMessage" class="hidden"></div>
            
            <form onsubmit="handleLifeRaftSubmit(event)">
                <input type="hidden" id="editLifeRaftId">
                
                <!-- Main Life Raft Info -->
                <div class="card" style="background: #f8f9fa; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #17a2b8;">Main Life Raft Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Designation</label>
                            <input type="text" id="liferaftDesignation" class="form-control" value="Life Raft" style="background: #f8f9fa;">
                        </div>
                        
                        <div class="form-group required">
                            <label>Part Number (P/N)</label>
                            <input type="text" id="liferaftPartNumber" class="form-control" placeholder="Enter life raft part number" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Serial Number (S/N)</label>
                            <input type="text" id="liferaftSerialNumber" class="form-control" placeholder="Enter life raft serial number">
                        </div>
                        
                        <div class="form-group">
                            <label>Order</label>
                            <input type="text" id="liferaftOrder" class="form-control" placeholder="Enter order number">
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="liferaftWorkInProgress">
                                Work in Progress
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>Inspection Date</label>
                            <input type="date" id="inspectionDate" class="form-control" onchange="calculateNextInspection()">
                        </div>
                        
                        <div class="form-group">
                            <label>Inspection Interval</label>
                            <input type="text" id="inspectionInterval" class="form-control" value="12 months" style="background: #f8f9fa;">
                        </div>
                        
                        <div class="form-group">
                            <label>Next Inspection</label>
                            <input type="date" id="nextInspection" class="form-control" style="background: #f8f9fa;">
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Comments</label>
                            <textarea id="liferaftComments" class="form-control" placeholder="Enter detailed comments about the life raft..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-Components -->
                <div class="card" style="background: #f8f9fa; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #17a2b8;">Life Raft Sub-Components (20 items)</h3>
                    <p style="color: #666; margin-bottom: 20px;">Fixed items and part numbers - enter S/N and expiry dates</p>
                    
                    <table class="sub-items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Part Number</th>
                                <th>S/N / Batch N¬∞</th>
                                <th>Expiry Date</th>
                            </tr>
                        </thead>
                        <tbody id="subItemsTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div id="expiryWarning" class="message message-error hidden">
                    ‚ö†Ô∏è <strong>Warning:</strong> Expired items will make the entire Life Raft <strong>Unserviceable</strong>.
                </div>
                
                <div class="mt-20">
                    <button type="submit" class="btn btn-success">üíæ Save Life Raft</button>
                    <button type="button" onclick="hideAllForms()" class="btn" style="margin-left: 15px;">‚ùå Cancel</button>
                </div>
            </form>
        </div>

        <!-- View All Life Rafts Table -->
        <div id="viewAllSection" class="panel hidden">
            <div class="panel-header module-efs">
                <span>üìã All Life Raft Systems</span>
                <span class="badge" id="tableCount">0</span>
            </div>
            <div class="panel-body">
                <div id="liferaftTable"></div>
            </div>
        </div>
    </div>

    <!-- Life Raft Detail Modal -->
    <div id="liferaftModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Life Raft Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
                <div class="mt-20 text-center">
                    <button onclick="editCurrentLifeRaft()" class="btn">‚úèÔ∏è Edit</button>
                    <button onclick="deleteCurrentLifeRaft()" class="btn btn-danger" style="margin-left: 15px;">üóëÔ∏è Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let liferaftData = [];
        let currentUser = sessionStorage.getItem('componentsBayCurrentUser') || sessionStorage.getItem('currentUser') || 'Unknown User';
        let userRole = localStorage.getItem('componentsBayUserRole') || localStorage.getItem('userRole') || 'user';
        let editingLifeRaft = null;
        let currentLifeRaftId = null;

        const subItems = [
            { item: 'SLEEVE, RATIONS', partNumber: '05829010' },
            { item: 'CARD, EMERGENCY PACK CONTENTS', partNumber: '05804018' },
            { item: 'SACHET, WATER 500 ML', partNumber: '05163009' },
            { item: 'SIGNAL DAY/NIGHT MK 8', partNumber: '11605009' },
            { item: 'PUMP, HAND (MIRADA)', partNumber: '11731009' },
            { item: 'LEAFLET, IMM. ACTION HELICRAFT', partNumber: '04935009' },
            { item: 'HELIOGRAPH 50 MM', partNumber: '05020001' },
            { item: 'STOPPER, LEAK NO. 1', partNumber: '40318001' },
            { item: 'STOPPER, LEAK NO. 3', partNumber: '05720019' },
            { item: 'STOPPER, LEAK NO. 5', partNumber: '05720023' },
            { item: 'SPONGE, VISCOSE', partNumber: '05720017' },
            { item: 'BALER, 6 PT', partNumber: '05720050' },
            { item: 'KIT, FIRST AID PACK NO. 2', partNumber: '06568001' },
            { item: 'TORCH', partNumber: '11140009' },
            { item: 'MINIFLARE PACK MK 8', partNumber: '11588009' },
            { item: 'TABLET, ANTI-SEASICKNESS (QTY 60)', partNumber: '01174009' },
            { item: 'BLANKET, THERMAL RESCUE', partNumber: '03817009' },
            { item: 'WHISTLE', partNumber: '05090005' },
            { item: 'REVERSE OSMOSIS PUMP', partNumber: '11125009' },
            { item: 'BAG, PLASTIC, MINIGRIP', partNumber: '11020009' }
        ];

        document.addEventListener('DOMContentLoaded', async function() {
            checkAuthentication();
            await loadData();
            updateSummary();
            updateUnserviceableSection();
            generateSubItemsTable();
        });

        function checkAuthentication() {
            if (!currentUser || currentUser === 'null') {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('userInfo').textContent = `${currentUser} (${userRole.toUpperCase()})`;
        }

        async function loadData() {
            if (window.ComponentsBayDB) {
                try {
                    liferaftData = await window.ComponentsBayDB.load('liferafts');
                    console.log('‚úÖ Liferafts loaded from Supabase:', liferaftData.length, 'items');
                } catch(e) {
                    console.error('Liferaft Supabase load failed, using localStorage');
                    const saved = localStorage.getItem('componentsBayLifeRafts');
                    if (saved) liferaftData = JSON.parse(saved);
                }
            } else {
                const saved = localStorage.getItem('componentsBayLifeRafts');
                if (saved) liferaftData = JSON.parse(saved);
            }
        }

        async function saveData() {
            localStorage.setItem('componentsBayLifeRafts', JSON.stringify(liferaftData));
            if (window.ComponentsBayDB) {
                for (const item of liferaftData) {
                    try {
                        await window.ComponentsBayDB.save('liferafts', {...item});
                    } catch(e) {
                        console.error('Liferaft save error:', e);
                    }
                }
                console.log('‚úÖ Liferafts synced to Supabase');
            }
        }

        function updateSummary() {
            // Check for overdue items first
            checkOverdueItems();
            
            const serviceable = liferaftData.filter(item => item.serviceability === 'Serviceable').length;
            const unserviceable = liferaftData.filter(item => item.serviceability === 'Unserviceable').length;
            
            document.getElementById('serviceableCount').textContent = serviceable;
            document.getElementById('unserviceableCount').textContent = unserviceable;
            document.getElementById('totalCount').textContent = liferaftData.length;
        }

        function checkOverdueItems() {
            const today = new Date();
            let hasChanges = false;
            
            liferaftData.forEach(item => {
                let isOverdue = false;
                let overdueReasons = [];
                
                // ONLY check sub-items expiry dates - this is what you wanted
                if (item.subItems) {
                    const expiredItems = [];
                    item.subItems.forEach(subItem => {
                        if (subItem.expiryDate) {
                            const expiryDate = new Date(subItem.expiryDate);
                            if (today > expiryDate) {
                                expiredItems.push(subItem.item);
                            }
                        }
                    });
                    
                    if (expiredItems.length > 0) {
                        isOverdue = true;
                        overdueReasons.push(`Expired items: ${expiredItems.join(', ')}`);
                    }
                }
                
                // Update item if overdue
                if (isOverdue && item.serviceability !== 'Unserviceable') {
                    item.serviceability = 'Unserviceable';
                    item.reason = overdueReasons.join('; ');
                    hasChanges = true;
                }
            });
            
            if (hasChanges) {
                saveData();
            }
        }

        function updateUnserviceableSection() {
            const unserviceableItems = liferaftData.filter(item => item.serviceability === 'Unserviceable');
            const tableContainer = document.getElementById('unserviceableTable');
            document.getElementById('unserviceableBadge').textContent = unserviceableItems.length;

            if (unserviceableItems.length === 0) {
                tableContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <p style="color: #00695c; font-weight: 600;">Excellent! No unserviceable life rafts</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Designation</th>
                                <th>P/N</th>
                                <th>S/N</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            unserviceableItems.forEach(item => {
                const reasonText = item.reason || 'Unserviceable';
                const reasonClass = item.reason && item.reason.includes('Expired') ? 'status-overdue' : 'status-unserviceable';
                
                tableHTML += `
                    <tr>
                        <td>${item.designation}</td>
                        <td>${item.partNumber}</td>
                        <td><a href="#" class="clickable" onclick="showLifeRaftDetail('${item.id}')">${item.serialNumber || '-'}</a></td>
                        <td><span class="status-badge ${reasonClass}">${reasonText}</span></td>
                        <td>
                            <button class="btn" onclick="editLifeRaft('${item.id}')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è Edit</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            tableContainer.innerHTML = tableHTML;
        }

        function hideAllForms() {
            document.getElementById('addLifeRaftForm').classList.add('hidden');
            document.getElementById('viewAllSection').classList.add('hidden');
        }

        function showAddLifeRaft() {
            hideAllForms();
            document.getElementById('addLifeRaftForm').classList.remove('hidden');
            // Only reset form if not editing
            if (!editingLifeRaft) {
                resetForm();
            }
        }

        function showAllLifeRafts() {
            hideAllForms();
            document.getElementById('viewAllSection').classList.remove('hidden');
            refreshTable();
        }

        function generateSubItemsTable() {
            const tbody = document.getElementById('subItemsTableBody');
            tbody.innerHTML = '';
            
            subItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${item.item}</td>
                    <td style="background: #f0f0f0; color: #666;">${item.partNumber}</td>
                    <td>
                        <input type="text" id="subitem_sn_${index}" placeholder="Enter S/N or Batch N¬∞">
                    </td>
                    <td>
                        <input type="date" id="subitem_expiry_${index}" onchange="checkExpiryDates()">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function checkExpiryDates() {
            const today = new Date();
            const warning30Days = new Date();
            warning30Days.setDate(today.getDate() + 30);
            
            let hasExpired = false;
            let expiredItems = [];
            
            subItems.forEach((item, index) => {
                const expiryInput = document.getElementById(`subitem_expiry_${index}`);
                const expiryDate = new Date(expiryInput.value);
                
                // Reset classes
                expiryInput.classList.remove('expired-date', 'expiring-soon');
                
                if (expiryInput.value) {
                    if (expiryDate < today) {
                        // Expired
                        expiryInput.classList.add('expired-date');
                        hasExpired = true;
                        expiredItems.push(item.item);
                    } else if (expiryDate < warning30Days) {
                        // Expiring within 30 days
                        expiryInput.classList.add('expiring-soon');
                    }
                }
            });
            
            const warning = document.getElementById('expiryWarning');
            warning.classList.toggle('hidden', !hasExpired);
            
            return { hasExpired, expiredItems };
        }

        function calculateNextInspection() {
            const inspectionDate = document.getElementById('inspectionDate').value;
            
            if (inspectionDate) {
                const baseDate = new Date(inspectionDate);
                const nextDate = new Date(baseDate);
                nextDate.setMonth(nextDate.getMonth() + 12); // Always 12 months
                
                document.getElementById('nextInspection').value = nextDate.toISOString().split('T')[0];
            } else {
                document.getElementById('nextInspection').value = '';
            }
        }

        function handleLifeRaftSubmit(event) {
            event.preventDefault();
            
            const partNumber = document.getElementById('liferaftPartNumber').value.trim();
            if (!partNumber) {
                showMessage('Life Raft Part Number (P/N) is required', 'error', 'liferaftMessage');
                return;
            }

            // Check expiry dates and collect sub-items data
            const expiryCheck = checkExpiryDates();
            const subItemsData = [];
            
            subItems.forEach((item, index) => {
                const sn = document.getElementById(`subitem_sn_${index}`).value.trim();
                const expiry = document.getElementById(`subitem_expiry_${index}`).value;
                
                subItemsData.push({
                    item: item.item,
                    partNumber: item.partNumber,
                    serialNumber: sn,
                    expiryDate: expiry
                });
            });

            const formData = {
                id: editingLifeRaft ? editingLifeRaft.id : Date.now().toString(),
                designation: 'Life Raft', // Always fixed
                partNumber: partNumber,
                serialNumber: document.getElementById('liferaftSerialNumber').value.trim(),
                order: document.getElementById('liferaftOrder').value.trim(),
                workInProgress: document.getElementById('liferaftWorkInProgress').checked,
                inspectionDate: document.getElementById('inspectionDate').value,
                inspectionInterval: '12', // Always 12 months
                nextInspection: document.getElementById('nextInspection').value,
                comments: document.getElementById('liferaftComments').value.trim(),
                subItems: subItemsData,
                serviceability: expiryCheck.hasExpired ? 'Unserviceable' : 'Serviceable',
                reason: expiryCheck.hasExpired ? `Expired items: ${expiryCheck.expiredItems.join(', ')}` : '',
                lastModified: new Date().toISOString(),
                modifiedBy: currentUser
            };

            if (editingLifeRaft) {
                const index = liferaftData.findIndex(item => item.id === editingLifeRaft.id);
                if (index !== -1) {
                    liferaftData[index] = formData;
                }
                editingLifeRaft = null;
            } else {
                liferaftData.push(formData);
            }

            saveData();
            updateSummary();
            updateUnserviceableSection();
            showMessage('Life Raft saved successfully', 'success', 'liferaftMessage');
            resetForm();
            
            if (!document.getElementById('viewAllSection').classList.contains('hidden')) {
                refreshTable();
            }
        }

        function resetForm() {
            document.getElementById('liferaftDesignation').value = 'Life Raft';
            document.getElementById('liferaftPartNumber').value = '';
            document.getElementById('liferaftSerialNumber').value = '';
            document.getElementById('liferaftOrder').value = '';
            document.getElementById('liferaftWorkInProgress').checked = false;
            document.getElementById('inspectionDate').value = '';
            document.getElementById('nextInspection').value = '';
            document.getElementById('liferaftComments').value = '';
            document.getElementById('editLifeRaftId').value = '';
            // Don't reset editingLifeRaft here - it should only be reset after successful save
            
            // Reset sub-items
            subItems.forEach((item, index) => {
                document.getElementById(`subitem_sn_${index}`).value = '';
                document.getElementById(`subitem_expiry_${index}`).value = '';
                document.getElementById(`subitem_expiry_${index}`).classList.remove('expired-date', 'expiring-soon');
            });
            
            checkExpiryDates();
            hideMessage();
        }

        function refreshTable() {
            const tableContainer = document.getElementById('liferaftTable');
            document.getElementById('tableCount').textContent = liferaftData.length;

            if (liferaftData.length === 0) {
                tableContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõü</div>
                        <p>No life raft systems registered</p>
                        <button onclick="showAddLifeRaft()" class="btn btn-add mt-20">+ Add First Life Raft</button>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Designation</th>
                                <th>P/N</th>
                                <th>S/N</th>
                                <th>Next Inspection</th>
                                <th>Serviceability</th>
                                <th>Sub-Items</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            liferaftData.forEach(item => {
                const statusClass = item.serviceability === 'Unserviceable' ? 'status-unserviceable' : 'status-serviceable';
                const expiredCount = item.subItems.filter(sub => {
                    if (!sub.expiryDate) return false;
                    return new Date(sub.expiryDate) < new Date();
                }).length;
                
                tableHTML += `
                    <tr>
                        <td>${item.designation}</td>
                        <td>${item.partNumber}</td>
                        <td><a href="#" class="clickable" onclick="showLifeRaftDetail('${item.id}')">${item.serialNumber || '-'}</a></td>
                        <td>${item.nextInspection || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${item.serviceability || 'N/A'}</span></td>
                        <td>${expiredCount > 0 ? `<span class="status-badge status-overdue">${expiredCount} expired</span>` : `${item.subItems.length} items`}</td>
                        <td>
                            <button class="btn" onclick="editLifeRaft('${item.id}')" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deleteLifeRaft('${item.id}')" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            tableContainer.innerHTML = tableHTML;
        }

        function showLifeRaftDetail(id) {
            const item = liferaftData.find(item => item.id === id);
            if (!item) return;

            currentLifeRaftId = id;
            document.getElementById('modalTitle').textContent = `Life Raft - ${item.partNumber}`;
            
            let subItemsHTML = '<table class="sub-items-table"><thead><tr><th>Item</th><th>P/N</th><th>S/N</th><th>Expiry Date</th><th>Status</th></tr></thead><tbody>';
            
            item.subItems.forEach(sub => {
                let statusBadge = '';
                if (sub.expiryDate) {
                    const expiryDate = new Date(sub.expiryDate);
                    const today = new Date();
                    const warning30Days = new Date();
                    warning30Days.setDate(today.getDate() + 30);
                    
                    if (expiryDate < today) {
                        statusBadge = '<span class="status-badge status-overdue">Expired</span>';
                    } else if (expiryDate < warning30Days) {
                        statusBadge = '<span class="status-badge status-warning">Expiring Soon</span>';
                    } else {
                        statusBadge = '<span class="status-badge status-serviceable">Valid</span>';
                    }
                }
                
                subItemsHTML += `
                    <tr>
                        <td>${sub.item}</td>
                        <td>${sub.partNumber}</td>
                        <td>${sub.serialNumber || '-'}</td>
                        <td>${sub.expiryDate || '-'}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            subItemsHTML += '</tbody></table>';
            
            const content = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Designation</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">${item.designation}</div>
                    </div>
                    <div class="form-group">
                        <label>Part Number</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">${item.partNumber}</div>
                    </div>
                    <div class="form-group">
                        <label>Serial Number</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">${item.serialNumber || '-'}</div>
                    </div>
                    <div class="form-group">
                        <label>Next Inspection</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">${item.nextInspection || '-'}</div>
                    </div>
                    <div class="form-group">
                        <label>Serviceability</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <span class="status-badge ${item.serviceability === 'Unserviceable' ? 'status-unserviceable' : 'status-serviceable'}">${item.serviceability || 'N/A'}</span>
                        </div>
                    </div>
                    ${item.reason ? `
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Reason</label>
                        <div style="padding: 10px; background: #fadbd8; border-radius: 6px; color: #c62828; font-weight: 600;">${item.reason}</div>
                    </div>
                    ` : ''}
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Comments</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; min-height: 60px;">${item.comments || '-'}</div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Sub-Components (${item.subItems.length} items)</label>
                        <div style="margin-top: 10px;">
                            ${subItemsHTML}
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Last Modified</label>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em; color: #636e72;">${new Date(item.lastModified).toLocaleString()} by ${item.modifiedBy}</div>
                    </div>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('liferaftModal').classList.add('active');
        }

        function editLifeRaft(id) {
            editingLifeRaft = liferaftData.find(item => item.id === id);
            if (!editingLifeRaft) return;

            // Fill form with existing data
            document.getElementById('liferaftPartNumber').value = editingLifeRaft.partNumber || '';
            document.getElementById('liferaftSerialNumber').value = editingLifeRaft.serialNumber || '';
            document.getElementById('inspectionDate').value = editingLifeRaft.inspectionDate || '';
            document.getElementById('inspectionInterval').value = editingLifeRaft.inspectionInterval || '';
            document.getElementById('nextInspection').value = editingLifeRaft.nextInspection || '';
            document.getElementById('liferaftComments').value = editingLifeRaft.comments || '';

            // Fill sub-items
            editingLifeRaft.subItems.forEach((sub, index) => {
                document.getElementById(`subitem_sn_${index}`).value = sub.serialNumber || '';
                document.getElementById(`subitem_expiry_${index}`).value = sub.expiryDate || '';
            });

            showAddLifeRaft();
            closeModal();
            checkExpiryDates();
        }

        function editCurrentLifeRaft() {
            if (currentLifeRaftId) {
                editLifeRaft(currentLifeRaftId);
            }
        }

        async function deleteLifeRaft(id) {
            if (confirm('Are you sure you want to delete this life raft system?')) {
                liferaftData = liferaftData.filter(item => item.id !== id);
                saveData();
                if (window.ComponentsBayDB) {
                    try { await window.ComponentsBayDB.delete('liferafts', id); } catch(e) { console.error('Liferaft delete error:', e); }
                }
                showMessage('Life Raft deleted successfully', 'success');
                updateSummary();
                updateUnserviceableSection();
                refreshTable();
            }
        }

        function deleteCurrentLifeRaft() {
            if (currentLifeRaftId) {
                deleteLifeRaft(currentLifeRaftId);
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('liferaftModal').classList.remove('active');
            currentLifeRaftId = null;
        }

        function exportData() {
            if (liferaftData.length === 0) {
                alert('No data to export');
                return;
            }

            const data = liferaftData.map(item => ({
                'Designation': item.designation,
                'Part Number': item.partNumber,
                'Serial Number': item.serialNumber || '',
                'Next Inspection': item.nextInspection || '',
                'Serviceability': item.serviceability || '',
                'Reason': item.reason || '',
                'Comments': item.comments || '',
                'Sub-Items': item.subItems.map(sub => `${sub.item}: ${sub.serialNumber || '-'} (Exp: ${sub.expiryDate || '-'})`).join(' | '),
                'Last Modified': new Date(item.lastModified).toLocaleString(),
                'Modified By': item.modifiedBy || ''
            }));

            downloadCSV(data, `LifeRaft_Export_${new Date().toISOString().split('T')[0]}.csv`);
            showMessage('Export completed successfully', 'success');
        }

        function downloadCSV(data, filename) {
            const csvContent = convertToCSV(data);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function convertToCSV(data) {
            if (!data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [];
            
            csvRows.push(headers.join(','));
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('componentsBayCurrentUser');
                localStorage.removeItem('componentsBayUserRole');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                window.location.href = 'index.html';
            }
        }

        function showMessage(message, type, elementId = null) {
            const element = elementId ? document.getElementById(elementId) : null;
            
            if (element) {
                element.textContent = message;
                element.className = `message message-${type}`;
                element.classList.remove('hidden');
                
                if (type === 'success') {
                    setTimeout(() => {
                        element.classList.add('hidden');
                    }, 3000);
                }
            } else {
                alert(message);
            }
        }

        function hideMessage() {
            const messageDiv = document.getElementById('liferaftMessage');
            if (messageDiv) {
                messageDiv.classList.add('hidden');
            }
        }

        // Close modal when clicking outside
        document.getElementById('liferaftModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>